<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title th:text="${post.id != null} ? '수정' : '새 글쓰기'">글쓰기</title>
  <meta name="_csrf" th:content="${_csrf.token}">
  <meta name="_csrf_header" th:content="${_csrf.headerName}">

  <style>
    .container{max-width:960px;margin:32px auto;padding:0 16px;font-family:system-ui,Arial}
    .toolbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin:12px 0 8px}
    button, input[type="submit"]{font:inherit;appearance:none;-webkit-appearance:none}
    a.btn, button.btn, input[type="submit"].btn,
    a.btn:link, a.btn:visited{
      display:inline-block;padding:8px 14px;border:1px solid #d1d5db;border-radius:6px;
      text-decoration:none;color:#111827;font-weight:600;background:#fff;cursor:pointer;line-height:1.2
    }
    a.btn:hover, button.btn:hover, input[type="submit"].btn:hover{background:#f3f4f6}
    .btn-primary{border-color:#2563eb}
    .btn-primary:hover{background:#eff6ff}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:18px}
    .field{margin-bottom:14px}
    .label{display:block;font-weight:600;margin-bottom:6px}
    .input, .textarea{width:100%;box-sizing:border-box;border:1px solid #d1d5db;border-radius:6px;padding:10px 12px;font:inherit}
    .textarea{min-height:220px;resize:vertical;line-height:1.5}
    .errors{background:#fef2f2;border:1px solid #fecaca;color:#991b1b;border-radius:6px;padding:10px 12px;margin-bottom:14px}
    .field .err{display:block;color:#b91c1c;font-size:14px;margin-top:6px}

    /* 업로드 UI */
    .dropzone{border:2px dashed #9ca3af;border-radius:8px;padding:18px;text-align:center;background:#fff}
    .dropzone.hover{background:#f9fafb}
    .upload-list{margin-top:10px;text-align:left;font-size:14px}
  </style>
</head>
<body>
  <div class="container" th:with="isEdit=${post.id != null}">
    <div class="toolbar">
      <h1 style="margin:0;" th:text="${isEdit} ? '수정' : '새 글쓰기'">글쓰기</h1>
      <div>
        <a th:href="@{/}" class="btn">메인</a>
        <a th:href="@{/posts}" class="btn">목록</a>
        <!-- 툴바 저장 버튼: form 속성으로 아래 폼 submit -->
        <!-- 
        <button type="submit" class="btn btn-primary" form="postForm">저장</button>
         -->
      </div>
    </div>

    <div class="card">
      <form id="postForm" th:object="${post}"
            th:action="${isEdit} ? @{/posts/{id}(id=${post.id})} : @{/posts}"
            method="post">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <!-- 수정일 때만 PUT 오버라이드 -->
        <input type="hidden" name="_method" th:if="${isEdit}" value="PUT"/>

        <!-- 업로드 드래프트 식별자: 저장 시 서버에서 마이그레이션에 사용 -->
        <input type="hidden" id="draftId" name="draftId"/>

        <!-- 글로벌 에러 -->
        <div class="errors" th:if="${#fields.hasErrors('*')}">
          <ul style="margin:0;padding-left:18px;">
            <li th:each="err : ${#fields.errors('*')}" th:text="${err}"></li>
          </ul>
        </div>

        <div class="field">
          <label for="title" class="label">제목</label>
          <input id="title" type="text" th:field="*{title}" class="input" required/>
          <span class="err" th:if="${#fields.hasErrors('title')}" th:errors="*{title}"></span>
        </div>

        <div class="field">
          <label for="content" class="label">내용</label>
          <textarea id="content" th:field="*{content}" class="textarea" required></textarea>
          <span class="err" th:if="${#fields.hasErrors('content')}" th:errors="*{content}"></span>
        </div>

        <!-- 파일 업로드 UI -->
        <div class="field">
          <label class="label">첨부 파일</label>
          <div id="dropzone" class="dropzone">
            파일을 이곳에 드래그
            <button type="button" id="btnBrowse" class="btn">파일 선택</button>
            <input type="file" id="fileInput" multiple style="display:none">
            <div id="uploadList" class="upload-list"></div>
          </div>
        </div>

        <!-- 기존 첨부파일 표시 및 삭제 -->
        <div class="field"
             th:if="${isEdit and attachments != null and !#lists.isEmpty(attachments)}">
          <label class="label">기존 첨부</label>
          <ul id="existingList" style="margin:6px 0 0 0;padding-left:18px;">
            <li th:each="a : ${attachments}" th:attr="data-id=${a.id}" style="margin-bottom:8px">
              <a th:href="@{|/attachments/${a.id}/download|}" th:text="${a.originalName}">filename</a>
              <small th:text="${#numbers.formatInteger(a.size/1024,0)} + ' KB'"></small>
              <button type="button" class="btn remove-attachment" th:attr="data-id=${a.id}">삭제</button>

              <!-- 이미지 썸네일 -->
              <div th:if="${a.originalName != null and (
                             #strings.endsWith(#strings.toLowerCase(a.originalName), '.png') or
                             #strings.endsWith(#strings.toLowerCase(a.originalName), '.jpg') or
                             #strings.endsWith(#strings.toLowerCase(a.originalName), '.jpeg') or
                             #strings.endsWith(#strings.toLowerCase(a.originalName), '.gif') or
                             #strings.endsWith(#strings.toLowerCase(a.originalName), '.webp')
                           )}" style="margin-top:6px">
                <img th:src="@{|/attachments/${a.id}/download|}" alt=""
                     style="max-width:160px;height:auto;border:1px solid #e5e7eb;border-radius:4px">
              </div>
            </li>
          </ul>
        </div>

        <!-- 하단 저장/취소 영역 + 폼 닫기 -->
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
          <a th:href="${isEdit} ? @{|/posts/${post.id}|} : @{/posts}" class="btn">취소</a>
          <button type="submit" class="btn btn-primary">저장</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 업로드 스크립트 -->
  <script>
  (function(){
    // CSRF
    const token  = document.querySelector('meta[name="_csrf"]')?.content;
    const header = document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN';

    // 드래프트 ID 생성
    const draftEl = document.getElementById('draftId');
    draftEl.value = (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now()+''+Math.random());

    const dz   = document.getElementById('dropzone');
    const list = document.getElementById('uploadList');
    const input= document.getElementById('fileInput');
    const btn  = document.getElementById('btnBrowse');

    btn.addEventListener('click', ()=> input.click());
    input.addEventListener('change', ()=> { handleFiles(input.files); input.value=''; });

    ['dragenter','dragover'].forEach(ev => dz.addEventListener(ev, e=>{
      e.preventDefault(); e.stopPropagation(); dz.classList.add('hover');
    }));
    ['dragleave','drop'].forEach(ev => dz.addEventListener(ev, e=>{
      e.preventDefault(); e.stopPropagation(); dz.classList.remove('hover');
    }));
    dz.addEventListener('drop', e=> handleFiles(e.dataTransfer.files));

    function handleFiles(files){
      [...files].forEach(f => uploadFile(f));
    }

    async function uploadFile(file){
      const row = document.createElement('div');
      row.textContent = `업로드 중: ${file.name} (${file.size} B)`;
      list.appendChild(row);

      const fd = new FormData();
      fd.append('draftId', draftEl.value);
      fd.append('file', file);

      try{
        const res = await fetch('/api/uploads/draft', {
          method: 'POST',
          headers: token ? { [header]: token } : {},
          body: fd
        });
        if(!res.ok) throw new Error('upload failed');
        const data = await res.json();
        const name = data.originalName || file.name;
        const size = data.size || file.size;

        row.className = 'upload-row';
        if (data.key) row.dataset.key = data.key;

        row.innerHTML =
          `완료: <a href="${data.url}" target="_blank" rel="noopener">${name}</a> · ${size} B`
          + (data.key ? ` <button type="button" class="btn remove-draft" data-key="${data.key}">삭제</button>` : '');
      }catch(e){
        row.textContent = `실패: ${file.name}`;
      }
    }

    // 기존 첨부 삭제
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('.remove-attachment');
      if (!btn) return;
      const id = btn.dataset.id || btn.getAttribute('data-id') || btn.closest('li')?.dataset.id;
      if (!id) return;
      if (!confirm('이 첨부파일을 삭제하시겠습니까?')) return;

      const res = await fetch(`/attachments/${id}`, {
        method: 'DELETE',
        headers: token ? { [header]: token } : {}
      });
      if (res.ok) {
        btn.closest('li')?.remove();
      } else {
        alert('삭제에 실패했습니다.');
      }
    });

    // 드래프트 파일 삭제
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('.remove-draft');
      if (!btn) return;
      const key = btn.dataset.key || btn.closest('.upload-row')?.dataset.key;
      if (!key) return;
      if (!confirm('이 파일을 제거하시겠습니까?')) return;

      const params = new URLSearchParams({ draftId: draftEl.value, key });
      const res = await fetch(`/api/uploads/draft?${params}`, {
        method: 'DELETE',
        headers: token ? { [header]: token } : {}
      });
      if (res.ok) {
        btn.closest('.upload-row')?.remove();
      } else {
        alert('삭제에 실패했습니다.');
      }
    });
  })();
  </script>
</body>
</html>
